name: Docker WeChat CI birdxs
on:
  workflow_dispatch:
  push:
    branches: [ "main-test" ]

env:
  DOCKER_REPOSITORY: ${{ secrets.DOCKERHUB_USERNAME }}  # 假设DOCKERHUB_USERNAME就是你的仓库名
  DOCKER_IMAGE_NAME: "docker-wechat"  # 或者从secrets读取

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:master

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build image with metadata
      id: build
      run: |
        # 构建镜像时添加更多元数据
        docker build \
          --no-cache \
          --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          --label "org.opencontainers.image.source=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" \
          --label "org.opencontainers.image.revision=$GITHUB_SHA" \
          -t temp-image .
        
    - name: Extract version and metadata
      id: extract
      run: |
        # 从容器内文件提取版本号
        NEW_VERSION=$(docker run --rm temp-image cat /etc/cont-env.d/APP_VERSION 2>/dev/null || echo "APP_VERSION=unknown")
        
        # 提取版本号值（去掉"APP_VERSION="前缀）
        NEW_VERSION_VALUE=$(echo "$NEW_VERSION" | cut -d'=' -f2)
        
        # 如果版本号为unknown，尝试从安装日志中提取
        if [ "$NEW_VERSION_VALUE" = "unknown" ]; then
          # 尝试从安装日志中提取版本号
          NEW_VERSION_VALUE=$(docker run --rm temp-image bash -c \
            'grep -o "Unpacking wechat ([0-9.]*)" /tmp/wechat_install.log 2>/dev/null | sed "s/Unpacking wechat (\(.*\))/\1/" || echo "unknown"')
        fi
        
        echo "new_version=${NEW_VERSION_VALUE}" >> $GITHUB_OUTPUT
        
        # 构建完整的镜像名称
        DOCKER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        IMAGE_NAME="wechat"  # 或者从输入/secrets获取
        
        if [ -z "$DOCKER_USERNAME" ]; then
          echo "Error: DOCKERHUB_USERNAME secret is not set!"
          exit 1
        fi
        
        FULL_IMAGE_NAME="${DOCKER_USERNAME}/${IMAGE_NAME}"
        echo "full_image_name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
        
        # 检查是否已有该版本的镜像存在
        if [ "$NEW_VERSION_VALUE" != "unknown" ] && [ -n "$NEW_VERSION_VALUE" ]; then
          if docker manifest inspect $FULL_IMAGE_NAME:$NEW_VERSION_VALUE >/dev/null 2>&1; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "version_exists=false" >> $GITHUB_OUTPUT
        fi
        
        # 提取应用名称
        APP_NAME=$(docker run --rm temp-image cat /etc/cont-env.d/APP_NAME 2>/dev/null || echo "APP_NAME=WeChat")
        APP_NAME_VALUE=$(echo "$APP_NAME" | cut -d'=' -f2)
        echo "app_name=${APP_NAME_VALUE}" >> $GITHUB_OUTPUT
        
        # 输出调试信息
        echo "Extracted version: $NEW_VERSION_VALUE"
        echo "Full image name: $FULL_IMAGE_NAME"
        echo "DockerHub username: $DOCKER_USERNAME"
        
    - name: Check version existence
      if: steps.extract.outputs.version_exists == 'true'
      run: |
        echo "Version ${{ steps.extract.outputs.new_version }} already exists in registry. Skipping push."
        
    - name: Tag and push image
      if: steps.extract.outputs.version_exists == 'false'
      run: |
        VERSION="${{ steps.extract.outputs.new_version }}"
        DOCKER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        IMAGE_NAME="wechat"
        FULL_IMAGE_NAME="${DOCKER_USERNAME}/${IMAGE_NAME}"
        
        echo "Using image name: $FULL_IMAGE_NAME"
        echo "Original version: $VERSION"
        
        # 清理版本号，只保留数字和点
        CLEAN_VERSION=$(echo "$VERSION" | grep -o '[0-9.]*' | head -1)
        if [ -z "$CLEAN_VERSION" ]; then
          # 如果没有有效版本号，使用日期作为标签
          DATE_TAG=$(date +%Y%m%d-%H%M%S)
          CLEAN_VERSION="build-$DATE_TAG"
          echo "No valid version found, using date-based tag: $CLEAN_VERSION"
        fi
        
        echo "Using version tag: $CLEAN_VERSION"
        
        # 标记镜像
        docker tag temp-image $FULL_IMAGE_NAME:$CLEAN_VERSION
        
        # 只有版本号包含数字和点时才推送latest标签
        if echo "$CLEAN_VERSION" | grep -q '^[0-9][0-9.]*[0-9]$'; then
          docker tag temp-image $FULL_IMAGE_NAME:latest
          echo "Will push both $CLEAN_VERSION and latest tags"
          
          # 推送镜像
          echo "Pushing $FULL_IMAGE_NAME:$CLEAN_VERSION"
          docker push $FULL_IMAGE_NAME:$CLEAN_VERSION
          
          echo "Pushing $FULL_IMAGE_NAME:latest"
          docker push $FULL_IMAGE_NAME:latest
        else
          echo "Will only push $CLEAN_VERSION tag (not latest)"
          echo "Pushing $FULL_IMAGE_NAME:$CLEAN_VERSION"
          docker push $FULL_IMAGE_NAME:$CLEAN_VERSION
        fi
        
        echo "Successfully pushed new version: $CLEAN_VERSION"
        
    - name: Clean up
      if: always()
      run: |
        # 清理临时镜像
        docker rmi temp-image 2>/dev/null || true
        
    - name: Create GitHub Release
      if: steps.extract.outputs.version_exists == 'false' && steps.extract.outputs.new_version != 'unknown' && steps.extract.outputs.new_version != '' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.extract.outputs.new_version }}
        name: WeChat ${{ steps.extract.outputs.new_version }}
        draft: false
        prerelease: false
        generate_release_notes: true
