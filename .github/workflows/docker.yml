name: Docker WeChat CI
on:
  workflow_dispatch:
  push:
    branches: [ "main-test" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # 升级到 v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:master

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}          
        
    - name: Build image with metadata
      id: build
      run: |
        # 构建镜像时添加更多元数据
        docker build \
          --no-cache \
          --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          --label "org.opencontainers.image.source=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" \
          --label "org.opencontainers.image.revision=$GITHUB_SHA" \
          -t temp-image .
        
    - name: Extract version and metadata
      id: extract
      run: |
        # 提取版本号和其他元数据
        NEW_VERSION=$(docker run --rm temp-image printenv APP_VERSION 2>/dev/null || echo "unknown")
        
        # 如果无法从环境变量获取，尝试其他方法
        if [ "$NEW_VERSION" = "unknown" ]; then
          # 尝试从容器内文件获取
          NEW_VERSION=$(docker run --rm temp-image bash -c \
            "find /etc/cont-env.d -name 'APP_VERSION' -exec cat {} \; 2>/dev/null || echo 'unknown'")
        fi
        
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        
        FULL_IMAGE_NAME="${{ secrets.DOCKER_REPOSITORY }}/${{ secrets.DOCKER_IMAGE_NAME }}"
        
        # 检查是否已有该版本的镜像存在
        if docker manifest inspect $FULL_IMAGE_NAME:$NEW_VERSION >/dev/null 2>&1; then
          echo "version_exists=true" >> $GITHUB_OUTPUT
        else
          echo "version_exists=false" >> $GITHUB_OUTPUT
        fi
        
        # 提取更多信息用于日志
        APP_NAME=$(docker run --rm temp-image printenv APP_NAME 2>/dev/null || echo "WeChat")
        echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
        
    - name: Check version existence
      if: steps.extract.outputs.version_exists == 'true'
      run: |
        echo "Version ${{ steps.extract.outputs.new_version }} already exists in registry. Skipping push."
        exit 0
        
    - name: Tag and push image
      if: steps.extract.outputs.version_exists == 'false'
      run: |
        VERSION="${{ steps.extract.outputs.new_version }}"
        FULL_IMAGE_NAME="${{ secrets.DOCKER_REPOSITORY }}/${{ secrets.DOCKER_IMAGE_NAME }}"
        
        # 清理版本号，只保留数字和点
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/[^0-9.]//g')
        if [ -z "$CLEAN_VERSION" ]; then
          CLEAN_VERSION="latest"
        fi
        
        # 标记镜像
        docker tag temp-image $FULL_IMAGE_NAME:$CLEAN_VERSION
        docker tag temp-image $FULL_IMAGE_NAME:latest
        
        # 推送镜像（先推送特定版本，再推送latest）
        docker push $FULL_IMAGE_NAME:$CLEAN_VERSION
        
        # 只有版本号有效时才推送latest标签
        if [ "$CLEAN_VERSION" != "latest" ] && [ "$CLEAN_VERSION" != "unknown" ]; then
          docker push $FULL_IMAGE_NAME:latest
        fi
        
        echo "Successfully pushed new version: $CLEAN_VERSION"
        
    - name: Clean up
      if: always()
      run: |
        # 清理临时镜像
        docker rmi temp-image 2>/dev/null || true
        
    - name: Create GitHub Release (Optional)
      if: steps.extract.outputs.version_exists == 'false' && steps.extract.outputs.new_version != 'unknown'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.extract.outputs.new_version }}
        name: WeChat ${{ steps.extract.outputs.new_version }}
        draft: false
        prerelease: false
